# Отчёт о разработке экстракторов Сарсекенова

## Цель проекта

Создание системы извлечения знаний из лекций Саламата Сарсекенова для AI-бота-психолога, который консультирует **исключительно в стиле нейро-сталкинга**.

**Критическое требование:** Бот должен использовать **ТОЛЬКО терминологию Сарсекенова**, игнорируя общую психологическую лексику.

---

## Этап 0: Подготовка структуры

**Статус:** Завершён

**Дата:** 2024-12-08

### Созданные директории

```
voice_bot_pipeline/
├── config/
│   └── terminology/          # Словари терминологии
├── text_processor/
│   ├── extractors/           # Будущие экстракторы
│   └── validators/           # Валидаторы
└── tests/
    └── extractors/           # Тесты
```

### Созданные файлы конфигурации

#### 1. `config/terminology/sarsekenov_terms.json`

Словарь терминов Сарсекенова, разбитый на 6 уровней (tiers):

| Уровень | Описание | Примеры терминов |
|---------|----------|------------------|
| tier_1_root | Корневые концепты | нейро-сталкинг, нео-сталкинг, сталкинг ума |
| tier_2_domain | Доменные области | поле внимания, чистое осознавание, присутствие |
| tier_3_practice | Практики | метанаблюдение, разотождествление, центрирование |
| tier_4_diagnostic | Диагностика | Я-образ, автоматизмы психики, захват внимания |
| tier_5_agents | Субъекты | Ищущий, наблюдающее сознание |
| tier_6_states | Состояния | бытие, здесь-и-сейчас, ясность |

**Всего терминов:** 45+

#### 2. `config/terminology/forbidden_terms.json`

Запрещённые термины общей психологии:

```json
{
  "forbidden_terms": ["эго", "ум", "подсознание", "медитация", "тревога", ...],
  "replacements": {
    "эго": "Я-образ",
    "подсознание": "автоматизмы психики",
    "медитация": "метанаблюдение",
    ...
  }
}
```

#### 3. `config/terminology/term_categories.json`

Паттерны категорий для извлечения:

- триада_трансформации
- работа_с_вниманием
- разотождествление
- состояния_сознания

#### 4. `config/extractors_config.yaml`

Общая конфигурация системы экстракторов с приоритетами и параметрами.

---

## Этап 1: TerminologyValidator

**Статус:** Завершён

**Дата:** 2024-12-08

### Файл: `text_processor/validators/terminology_validator.py`

**Назначение:** Фундамент системы - валидация текста перед обработкой экстракторами.

### Ключевые компоненты

#### 1. Класс `ValidationResult`

```python
@dataclass
class ValidationResult:
    is_valid: bool              # Прошёл ли текст валидацию
    reason: str                 # Причина (успех/отказ)
    metrics: Dict               # Метрики плотности
    forbidden_terms_found: List # Найденные запрещённые термины
    sarsekenov_entities: List   # Извлечённые термины Сарсекенова
```

#### 2. Класс `TerminologyValidator`

**Основные методы:**

| Метод | Описание |
|-------|----------|
| `validate_text()` | Главный метод валидации |
| `_find_forbidden_terms()` | Поиск запрещённых терминов |
| `_calculate_density()` | Расчёт плотности терминов (мин. 25%) |
| `_extract_entities()` | Извлечение сущностей Сарсекенова |
| `replace_forbidden_terms()` | Замена запрещённых на разрешённые |
| `get_term_info()` | Информация о термине (tier, level) |

### Лемматизация (pymorphy3)

Добавлена поддержка морфологического анализа для корректной работы с русским языком:

- "разотождествлению" → "разотождествление"
- "Я-образом" → "я-образ"
- "метанаблюдения" → "метанаблюдение"

**Зависимость:** `pymorphy3` (для Python 3.11+)

```bash
pip install pymorphy3
```

### Алгоритм валидации

```
1. Проверка на запрещённые термины (strict_mode)
   └── Если найдены → ОТКЛОНИТЬ
   
2. Расчёт плотности терминов Сарсекенова
   └── Если < 25% → ОТКЛОНИТЬ
   
3. Извлечение сущностей
   └── Возврат списка найденных терминов
   
4. Успешная валидация
   └── ПРИНЯТЬ с метриками
```

### Тесты: `tests/extractors/test_terminology_validator.py`

| Тест | Описание | Результат |
|------|----------|-----------|
| test_valid_sarsekenov_text | Валидный текст проходит | Плотность 52.2%, 11 терминов |
| test_invalid_forbidden_terms | Запрещённые термины отклоняются | 5 терминов найдено |
| test_low_density_text | Низкая плотность отклоняется | 5.3% < 25% |
| test_entity_extraction | Извлечение сущностей | 8 сущностей |
| test_term_replacement | Замена терминов | Работает |
| test_get_term_info | Информация о термине | Работает |

**Результат:** ВСЕ ТЕСТЫ ПРОЙДЕНЫ

### Пример использования

```python
from text_processor.validators import TerminologyValidator

validator = TerminologyValidator()

text = """
Когда Ищущий практикует метанаблюдение, он начинает замечать 
появление Я-образа в поле внимания. Через разотождествление 
возникает свободное внимание и чистое осознавание.
"""

result = validator.validate_text(text)

print(f"Валиден: {result.is_valid}")
print(f"Плотность: {result.metrics['density']:.1%}")
print(f"Термины: {result.sarsekenov_entities}")
```

**Вывод:**
```
Валиден: True
Плотность: 52.2%
Термины: ['центрирование', 'разотождествление', 'чистое осознавание', ...]
```

---

## Архитектурные заметки

### Сохранение полного текста в RAG

**Важно:** Валидатор НЕ удаляет "нейтральные" слова из текста. Он только:
- Проверяет плотность терминов Сарсекенова
- Извлекает сущности для метаданных
- Блокирует тексты с запрещёнными терминами

**Правильная архитектура RAG-индекса:**

```
┌─────────────────────────────────────────────────────────────┐
│                    Документ в индексе                       │
├─────────────────────────────────────────────────────────────┤
│  full_text      = весь текст блока (для семантического      │
│                   поиска и генерации ответов)               │
│                                                             │
│  entities       = ["метанаблюдение", "Я-образ", ...]        │
│                   (для фильтрации и ранжирования)           │
│                                                             │
│  metadata = {                                               │
│    "density": 0.52,                                         │
│    "is_valid": true,                                        │
│    "tier_distribution": {"tier_3": 5, "tier_4": 3},         │
│    "source": "lecture_001.txt"                              │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
```

**Категории слов и их обработка:**

| Категория | Примеры | Действие | В индексе |
|-----------|---------|----------|-----------|
| Термины Сарсекенова | метанаблюдение, Я-образ | Извлекаются как entities | full_text + entities |
| Запрещённые | эго, медитация | Блокируют текст | Не попадает |
| Нейтральные | человек, понять, работа | Игнорируются валидатором | full_text |

**Поток обработки:**

```
Исходный текст
      │
      ▼
┌─────────────────┐
│  Валидация      │──── is_valid=False ───► Отклонить
│  (density≥25%,  │
│   no forbidden) │
└────────┬────────┘
         │ is_valid=True
         ▼
┌─────────────────┐
│  Сохранить в    │
│  RAG-индекс:    │
│  • full_text    │
│  • entities     │
│  • metadata     │
└─────────────────┘
```

**Вывод:** Информация не теряется. Семантический поиск работает по полному тексту, а entities используются для:
- Фильтрации результатов по конкретным терминам
- Ранжирования (тексты с большей плотностью выше)
- Формирования ответов бота в стиле Сарсекенова

---

## Следующие этапы

- [ ] **Этап 2:** NeurostalkingPatternExtractor
- [ ] **Этап 3:** CausalChainExtractor (с валидацией)
- [ ] **Этап 4:** ConceptHierarchyExtractor (с валидацией)
- [ ] **Этап 5:** Интеграция с оркестратором

---

## Зависимости

```
pymorphy3>=1.0.0
```

## Структура проекта после Этапа 1

```
voice_bot_pipeline/
├── config/
│   ├── extractors_config.yaml
│   └── terminology/
│       ├── sarsekenov_terms.json
│       ├── forbidden_terms.json
│       └── term_categories.json
├── text_processor/
│   ├── validators/
│   │   ├── __init__.py
│   │   └── terminology_validator.py
│   └── extractors/
│       └── __init__.py
└── tests/
    ├── __init__.py
    └── extractors/
        ├── __init__.py
        └── test_terminology_validator.py
```
